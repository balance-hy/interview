# Mysql 面试题

![image-20240424102149535](https://raw.githubusercontent.com/balance-hy/typora/master/thinkbook/image-20240424102149535.png)

## 优化

### 如何定位慢查询

* 聚合查询 有聚合函数的查询比如 Sum、Avg、Count等
* 多表查询
* 表数据量过大查询
* 深度分页查询

**现象：页面加载过慢、接口压测响应时间过长(超过1s)**

#### 解决方案一：

* 调试工具：Arthas
* 运维工具：Prometheus、Skywalking

#### 解决方案二：Mysql自带慢日志

> 调试阶段开启，避免损耗性能

慢查询日志记录了**所有执行时间超过指定参数**（long_query_time，单位：秒，默认10秒）的所有SQL语句的日志如果要开启慢查询日志，需要在MySQL的配置文件（/etc/my.cnf）中配置如下信息：

```shell
# 开启MySQL慢日志查询开关
slow_query_log=1
# 设置慢日志的时间为2秒，SQL语句执行时间超过2秒，就会视为慢查询，记录慢查询日志
long_query_time=2
```

****

### 慢查询如何分析

![image-20240424103717316](https://raw.githubusercontent.com/balance-hy/typora/master/thinkbook/image-20240424103717316.png)

* possible_key 当前sql可能会使用到的索

* **key 当前sql实际命中的索引**

* **key_len 索引占用的大小**

* Extra 额外的优化建议
  * Using where; Using Index
    * 查找使用了索引，需要的数据都在索引列中能找到，不需要回表查询数据
  * Using index condition
    * 查找使用了索引，但是需要回表查询数据
* type 这条sql的连接的类型，性能由好到差为NULL、system、const、eq_ref、ref、range、index、all
  * system:查询系统中的表
  * const:根据主键查询
  * eq_ref:主键索引查询或唯一索引查询
  * ref：索引查询
  * range:范围查询
  * **index:索引树扫描**
  * **all:全盘扫描**

>如果一条sql执行很慢的话，我们通常会使用mysql自动的执行计划explain来去查看这条sql的执行情况。
>
>比如在这里面可以通过**key和key_len检查是否命中了索引**，如果本身已经添加了索引，也可以判断索引是否有失效的情况。
>
>第二个，可以通过type字段查看sql是否有进一步的优化空间，是否存在全索引扫描或全盘扫描，第三个可以通过extra建议来判断，是否出现了回表的情况，如果出现了，可以尝试添加索引或修改返回字段来修复

****

### 索引概念、索引底层数据结构

> 了解过索引吗？(什么是索引）

索引（index）是帮助MYSQL高效获取数据的的数据结构（有序）。提高数据检索效率，降低数据库IO成本（无需全表扫描）

在数据之外，数据库系统还维护看满足特定查找算法的数据结构**（B+树）**，这些数据结构以某种方式引用（指向）数据，这样就可以在这些数据结构上实现高级查找算法，这种数据结构就是索引。

#### 二叉树、红黑树

> 二叉树（Binary Tree）是一种树形数据结构，其中每个节点最多有两个子节点，通常称为左子节点和右子节点。二叉树的每个节点都包含一个数据元素（称为键值）以及指向其左子树和右子树的指针。
>
> 二叉树可以为空（即不包含任何节点），或者由一个根节点和零个或多个子树组成，每个子树也是二叉树。

二叉搜索树（Binary Search Tree，BST）是一种特殊的二叉树，具有以下性质：

1. 左子树上所有节点的键值小于根节点的键值。
2. 右子树上所有节点的键值大于根节点的键值。
3. 左子树和右子树都是二叉搜索树。

二叉搜索树的时间复杂度取决于树的高度，平均情况下，查找、插入和删除操作的时间复杂度为O(log n)，其中n是树中节点的数量。然而，在最坏情况下，当二叉搜索树退化成链表时，时间复杂度会退化为O(n)。

**为了保持二叉搜索树的平衡，通常会使用自平衡二叉搜索树，例如AVL树和红黑树。**

红黑树（Red-Black Tree）是一种自平衡二叉搜索树，它是在普通二叉搜索树的基础上引入了额外的约束和操作，以保持树的平衡性。

**红黑树的特点在于它的每个节点都带有一个额外的表示节点颜色的属性，该颜色可以是红色或黑色。**

红黑树具有以下性质：

1. 每个节点要么是红色，要么是黑色。
2. 根节点是黑色的。
3. 每个叶子节点（NIL节点，即空节点）是黑色的。
4. 如果一个节点是红色的，则其子节点必须是黑色的（反之不一定成立）。
5. **从任意节点到其每个叶子节点的所有路径都包含相同数量的黑色节点。**

![image-20240424105159217](https://raw.githubusercontent.com/balance-hy/typora/master/thinkbook/image-20240424105159217.png)

#### B树和B+树

> 当数据量过大，无疑前面的二叉树的层级会很高，这样也会导致搜索效率的降低
